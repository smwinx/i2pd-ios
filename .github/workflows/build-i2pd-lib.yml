name: Build i2pd iOS Library

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-i2pd-lib.yml'
      - 'scripts/build_i2pd_ios.sh'

env:
  OPENSSL_VERSION: '3.0.12'
  BOOST_VERSION: '1.84.0'
  I2PD_VERSION: '2.50.2'
  IOS_MIN_VERSION: '14.0'

jobs:
  build-ios-libs:
    runs-on: macos-14
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: Install build deps
        run: |
          brew install cmake libtool || true

      - name: Run build script
        env:
          I2PD_VERSION: ${{ env.I2PD_VERSION }}
          OPENSSL_VERSION: ${{ env.OPENSSL_VERSION }}
          BOOST_VERSION: ${{ env.BOOST_VERSION }}
          IOS_MIN_VERSION: ${{ env.IOS_MIN_VERSION }}
        run: |
          set -x
          cd scripts
          chmod +x build_i2pd_ios.sh
          bash -x ./build_i2pd_ios.sh

      - name: Generate podspec
        run: |
          cd scripts/output
          cat > i2pd.podspec << 'PODSPEC_EOF'
          Pod::Spec.new do |s|
            s.name             = 'i2pd'
            s.version          = '2.58.0'
            s.summary          = 'i2pd iOS libs'
            s.homepage         = 'https://i2pd.website/'
            s.license          = { :type => 'BSD' }
            s.author           = 'PurpleI2P'
            s.source           = { :path => '.' }
            s.platform         = :ios, '14.0'
            s.vendored_libraries = 'lib/*.a'
            s.public_header_files = 'include/**/*.{h,hpp}'
            s.libraries = 'c++', 'z'
          end
          PODSPEC_EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: i2pd-ios-universal
          path: scripts/output
          retention-days: 30
