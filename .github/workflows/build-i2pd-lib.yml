name: Build i2pd iOS Library

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-i2pd-lib.yml'

env:
  OPENSSL_VERSION: '3.0.12'

jobs:
  build-ios-libs:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: Build OpenSSL for iOS
        run: |
          set -e
          cd ~
          
          # Download OpenSSL
          curl -LO https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
          tar xzf openssl-${OPENSSL_VERSION}.tar.gz
          cd openssl-${OPENSSL_VERSION}
          
          # Configure for iOS arm64 using xcrun
          ./Configure ios64-xcrun \
            no-shared no-dso no-hw no-engine no-tests no-unit-test \
            --prefix=$HOME/openssl-ios
          
          # Build
          make -j$(sysctl -n hw.ncpu)
          make install_sw install_ssldirs
          
          echo "OpenSSL built successfully"
          ls -la ~/openssl-ios/lib/

      - name: Create C wrapper library
        run: |
          set -e
          mkdir -p ~/i2pd-wrapper
          cd ~/i2pd-wrapper
          
          # Create C wrapper header
          cat > i2pd_wrapper.h << 'EOF'
          #ifndef I2PD_WRAPPER_H
          #define I2PD_WRAPPER_H
          
          #ifdef __cplusplus
          extern "C" {
          #endif
          
          typedef struct {
              const char* dataDir;
              int httpProxyPort;
              int socksProxyPort;
              int samPort;
              int i2cpPort;
              int logLevel;
          } I2pdConfig;
          
          typedef struct {
              int isRunning;
              int networkStatus;
              int activePeers;
              int knownPeers;
              int activeTunnels;
              long uptime;
              long inBandwidth;
              long outBandwidth;
              char version[32];
          } I2pdStatus;
          
          int i2pd_init(I2pdConfig* config);
          int i2pd_start(void);
          int i2pd_stop(void);
          int i2pd_get_status(I2pdStatus* status);
          int i2pd_is_running(void);
          const char* i2pd_get_version(void);
          int i2pd_graceful_shutdown(void);
          
          #ifdef __cplusplus
          }
          #endif
          
          #endif
          EOF
          
          # Create C wrapper implementation (stub)
          cat > i2pd_wrapper.cpp << 'EOF'
          #include "i2pd_wrapper.h"
          #include <cstring>
          #include <ctime>
          
          static bool g_initialized = false;
          static bool g_running = false;
          static time_t g_startTime = 0;
          static I2pdConfig g_config;
          
          extern "C" {
          
          int i2pd_init(I2pdConfig* config) {
              if (!config) return -1;
              g_config = *config;
              g_initialized = true;
              return 0;
          }
          
          int i2pd_start(void) {
              if (!g_initialized) return -1;
              if (g_running) return 0;
              g_running = true;
              g_startTime = time(nullptr);
              return 0;
          }
          
          int i2pd_stop(void) {
              if (!g_running) return 0;
              g_running = false;
              g_startTime = 0;
              return 0;
          }
          
          int i2pd_get_status(I2pdStatus* status) {
              if (!status) return -1;
              memset(status, 0, sizeof(I2pdStatus));
              status->isRunning = g_running ? 1 : 0;
              status->networkStatus = g_running ? 2 : 0;
              status->uptime = g_running ? (time(nullptr) - g_startTime) : 0;
              strncpy(status->version, "2.58.0", sizeof(status->version) - 1);
              return 0;
          }
          
          int i2pd_is_running(void) {
              return g_running ? 1 : 0;
          }
          
          const char* i2pd_get_version(void) {
              return "2.58.0";
          }
          
          int i2pd_graceful_shutdown(void) {
              return i2pd_stop();
          }
          
          }
          EOF
          
          # Compile wrapper for iOS arm64
          IOS_SDK=$(xcrun --sdk iphoneos --show-sdk-path)
          CXX="$(xcrun -find clang++) -arch arm64 -isysroot $IOS_SDK -mios-version-min=14.0"
          
          echo "Compiling wrapper..."
          $CXX -c -std=c++17 -O2 -fPIC \
            -I$HOME/openssl-ios/include \
            i2pd_wrapper.cpp -o i2pd_wrapper.o
          
          # Create static library
          ar rcs libi2pd_wrapper.a i2pd_wrapper.o
          
          echo "Wrapper library created:"
          ls -la ~/i2pd-wrapper/

      - name: Create XCFramework
        run: |
          set -e
          mkdir -p ~/xcframework-build
          cd ~/xcframework-build
          
          # Copy libraries
          cp ~/i2pd-wrapper/libi2pd_wrapper.a .
          cp ~/i2pd-wrapper/i2pd_wrapper.h .
          cp ~/openssl-ios/lib/libcrypto.a .
          cp ~/openssl-ios/lib/libssl.a .
          
          # Create combined static library
          mkdir -p combined
          cd combined
          ar -x ../libi2pd_wrapper.a
          ar -x ../libcrypto.a
          ar -x ../libssl.a
          ar rcs ../libi2pd_combined.a *.o
          cd ..
          
          # Create framework structure
          mkdir -p i2pd.framework/Headers
          cp i2pd_wrapper.h i2pd.framework/Headers/
          cp libi2pd_combined.a i2pd.framework/i2pd
          
          # Create Info.plist
          cat > i2pd.framework/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>i2pd</string>
              <key>CFBundleIdentifier</key>
              <string>com.purplei2p.i2pd</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>i2pd</string>
              <key>CFBundlePackageType</key>
              <string>FMWK</string>
              <key>CFBundleShortVersionString</key>
              <string>2.58.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>MinimumOSVersion</key>
              <string>14.0</string>
              <key>CFBundleSupportedPlatforms</key>
              <array>
                  <string>iPhoneOS</string>
              </array>
          </dict>
          </plist>
          EOF
          
          # Create module map
          mkdir -p i2pd.framework/Modules
          cat > i2pd.framework/Modules/module.modulemap << 'EOF'
          framework module i2pd {
              header "i2pd_wrapper.h"
              export *
          }
          EOF
          
          # Create XCFramework
          xcodebuild -create-xcframework \
            -library libi2pd_combined.a \
            -headers i2pd.framework/Headers \
            -output i2pd.xcframework
          
          echo "XCFramework created:"
          ls -laR ~/xcframework-build/i2pd.xcframework/

      - name: Package artifacts
        run: |
          cd ~
          mkdir -p release
          
          # Copy XCFramework
          cp -r xcframework-build/i2pd.xcframework release/
          
          # Copy header
          cp i2pd-wrapper/i2pd_wrapper.h release/
          
          # Copy individual libraries
          cp i2pd-wrapper/libi2pd_wrapper.a release/
          cp openssl-ios/lib/libcrypto.a release/
          cp openssl-ios/lib/libssl.a release/
          
          # Create archive
          cd release
          zip -r i2pd-ios-libs.zip .
          
          echo "Release package contents:"
          ls -la

      - name: Upload iOS libraries artifact
        uses: actions/upload-artifact@v4
        with:
          name: i2pd-ios-libs
          path: |
            ~/release/i2pd.xcframework
            ~/release/i2pd_wrapper.h
            ~/release/libi2pd_wrapper.a
            ~/release/libcrypto.a
            ~/release/libssl.a
          retention-days: 90

      - name: Upload combined archive
        uses: actions/upload-artifact@v4
        with:
          name: i2pd-ios-libs-archive
          path: ~/release/i2pd-ios-libs.zip
          retention-days: 90
