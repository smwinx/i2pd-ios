name: Build i2pd iOS Library

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-i2pd-lib.yml'

# Build ACTUAL i2pd library using CMake + ios-cmake toolchain (official method)
# Based on: https://i2pd.readthedocs.io/en/latest/devs/building/ios/
# And: https://github.com/vovasty/SwiftyI2P
env:
  OPENSSL_VERSION: '3.0.12'
  BOOST_VERSION: '1.84.0'
  BOOST_VERSION_UNDERSCORE: '1_84_0'
  I2PD_VERSION: '2.54.0'
  IOS_MIN_VERSION: '14.0'

jobs:
  build-ios-libs:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode 15
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: Install build tools
        run: |
          brew install cmake autoconf automake libtool || true
          cmake --version
          xcodebuild -version

      - name: Setup build directories
        run: |
          mkdir -p ~/build/{openssl,boost,i2pd}
          mkdir -p ~/deps/{include,lib}
          mkdir -p ~/output

      - name: Clone ios-cmake toolchain
        run: |
          cd ~
          git clone --depth 1 https://github.com/leetal/ios-cmake.git
          echo "IOS_TOOLCHAIN=$HOME/ios-cmake/ios.toolchain.cmake" >> $GITHUB_ENV
          ls -la ~/ios-cmake/

      # ==============================================================
      # BUILD OPENSSL FOR iOS arm64
      # ==============================================================
      - name: Build OpenSSL for iOS
        run: |
          cd ~/build/openssl
          
          echo "=== Downloading OpenSSL ${OPENSSL_VERSION} ==="
          curl -LO https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
          tar xzf openssl-${OPENSSL_VERSION}.tar.gz
          cd openssl-${OPENSSL_VERSION}
          
          export CROSS_TOP="$(xcode-select -p)/Platforms/iPhoneOS.platform/Developer"
          export CROSS_SDK="iPhoneOS.sdk"
          
          echo "=== Configuring OpenSSL for iOS arm64 ==="
          ./Configure ios64-xcrun \
            no-shared no-dso no-hw no-engine no-tests no-unit-test \
            --prefix=$HOME/deps
          
          echo "=== Building OpenSSL ==="
          make -j$(sysctl -n hw.ncpu)
          make install_sw install_ssldirs
          
          echo "=== Verifying OpenSSL ==="
          ls -la ~/deps/lib/libssl.a ~/deps/lib/libcrypto.a
          file ~/deps/lib/libssl.a
          lipo -info ~/deps/lib/libssl.a
          echo "OpenSSL built successfully"

      # ==============================================================
      # BUILD BOOST FOR iOS arm64
      # ==============================================================
      - name: Build Boost for iOS
        run: |
          cd ~/build/boost
          
          echo "=== Downloading Boost ${BOOST_VERSION} ==="
          curl -LO https://boostorg.jfrog.io/artifactory/main/release/${BOOST_VERSION}/source/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz
          tar xzf boost_${BOOST_VERSION_UNDERSCORE}.tar.gz
          cd boost_${BOOST_VERSION_UNDERSCORE}
          
          IOS_SDK=$(xcrun --sdk iphoneos --show-sdk-path)
          IOS_SDK_VERSION=$(xcrun --sdk iphoneos --show-sdk-version)
          XCODE_ROOT=$(xcode-select -p)
          COMPILER="$XCODE_ROOT/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang++"
          
          echo "=== iOS SDK: $IOS_SDK ==="
          echo "=== SDK Version: $IOS_SDK_VERSION ==="
          
          echo "=== Bootstrapping Boost ==="
          ./bootstrap.sh --with-libraries=system,filesystem,program_options,date_time
          
          echo "=== Creating iOS toolchain config ==="
          cat > tools/build/src/user-config.jam << 'JAMEOF'
          using darwin : iphoneos
            : xcrun --sdk iphoneos clang++ -arch arm64 -std=c++17 -stdlib=libc++ -miphoneos-version-min=14.0 -fvisibility=hidden -fvisibility-inlines-hidden -DBOOST_AC_USE_PTHREADS -DBOOST_SP_USE_PTHREADS
            : <striper> <root>/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer
            : <architecture>arm <target-os>iphone
            ;
          JAMEOF
          
          echo "=== user-config.jam ==="
          cat tools/build/src/user-config.jam
          
          echo "=== Building Boost static libraries ==="
          ./b2 -j$(sysctl -n hw.ncpu) \
            toolset=darwin-iphoneos \
            target-os=iphone \
            architecture=arm \
            link=static \
            variant=release \
            threading=multi \
            define=_LITTLE_ENDIAN \
            --prefix=$HOME/deps \
            --build-dir=$HOME/build/boost/build \
            install 2>&1 || true
          
          echo "=== Copying Boost headers ==="
          if [ ! -d ~/deps/include/boost ]; then
            cp -r boost ~/deps/include/
          fi
          
          echo "=== Looking for built Boost libs ==="
          find ~/build/boost -name "libboost*.a" 2>/dev/null | head -20
          find ~/deps -name "libboost*.a" 2>/dev/null | head -20
          
          # Copy any built libs to deps
          find ~/build/boost -name "libboost*.a" -exec cp {} ~/deps/lib/ \; 2>/dev/null || true
          
          echo "=== Boost libraries ==="
          ls -la ~/deps/lib/libboost*.a 2>/dev/null || echo "Boost libs may not have built - will use header-only"
          
          echo "Boost setup complete"

      # ==============================================================
      # BUILD i2pd USING CMAKE (Official method)
      # ==============================================================
      - name: Clone i2pd source
        run: |
          cd ~
          echo "=== Cloning i2pd ${I2PD_VERSION} ==="
          git clone --depth 1 --branch ${I2PD_VERSION} https://github.com/PurpleI2P/i2pd.git i2pd-src || \
            git clone --depth 1 https://github.com/PurpleI2P/i2pd.git i2pd-src
          
          cd i2pd-src
          ls -la
          echo "=== libi2pd sources ==="
          ls libi2pd/*.cpp | wc -l
          echo "=== libi2pd_client sources ==="
          ls libi2pd_client/*.cpp | wc -l

      - name: Build i2pd with CMake for iOS
        run: |
          cd ~/i2pd-src
          
          echo "=== Creating CMake build directory ==="
          mkdir -p build-ios
          cd build-ios
          
          echo "=== Configuring i2pd with CMake for iOS arm64 ==="
          cmake ../build \
            -DCMAKE_TOOLCHAIN_FILE=$HOME/ios-cmake/ios.toolchain.cmake \
            -DPLATFORM=OS64 \
            -DDEPLOYMENT_TARGET=${IOS_MIN_VERSION} \
            -DCMAKE_BUILD_TYPE=Release \
            -DWITH_STATIC=ON \
            -DWITH_BINARY=OFF \
            -DWITH_UPNP=OFF \
            -DBoost_INCLUDE_DIR=$HOME/deps/include \
            -DBoost_LIBRARY_DIR=$HOME/deps/lib \
            -DOPENSSL_ROOT_DIR=$HOME/deps \
            -DOPENSSL_INCLUDE_DIR=$HOME/deps/include \
            -DOPENSSL_SSL_LIBRARY=$HOME/deps/lib/libssl.a \
            -DOPENSSL_CRYPTO_LIBRARY=$HOME/deps/lib/libcrypto.a \
            -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY=$HOME/output
          
          echo "=== Building i2pd ==="
          cmake --build . --config Release -j$(sysctl -n hw.ncpu) 2>&1 || {
            echo "CMake build failed, trying manual compilation..."
            exit 1
          }
          
          echo "=== i2pd build complete ==="
          ls -la $HOME/output/ 2>/dev/null || ls -la
          find . -name "*.a" -exec ls -la {} \;

      - name: Manual i2pd compilation fallback
        if: failure()
        run: |
          cd ~/i2pd-src
          
          IOS_SDK=$(xcrun --sdk iphoneos --show-sdk-path)
          CXX="$(xcrun -find clang++)"
          AR="$(xcrun -find ar)"
          RANLIB="$(xcrun -find ranlib)"
          
          CXXFLAGS="-arch arm64 -isysroot $IOS_SDK -miphoneos-version-min=${IOS_MIN_VERSION} -std=c++17 -stdlib=libc++ -fPIC -O2 -DMAC_OSX -DOPENSSL_SUPPRESS_DEPRECATED"
          INCLUDES="-I$HOME/deps/include -Ilibi2pd -Ilibi2pd_client -Ii18n"
          
          echo "=== Manual compilation of libi2pd ==="
          mkdir -p obj/libi2pd obj/libi2pd_client obj/i18n
          
          for src in libi2pd/*.cpp; do
            name=$(basename "$src" .cpp)
            echo "Compiling $src..."
            $CXX $CXXFLAGS $INCLUDES -c "$src" -o "obj/libi2pd/$name.o" 2>&1 || echo "Warning: $src failed"
          done
          
          for src in libi2pd_client/*.cpp; do
            name=$(basename "$src" .cpp)
            echo "Compiling $src..."
            $CXX $CXXFLAGS $INCLUDES -c "$src" -o "obj/libi2pd_client/$name.o" 2>&1 || echo "Warning: $src failed"
          done
          
          for src in i18n/*.cpp; do
            name=$(basename "$src" .cpp)
            echo "Compiling $src..."
            $CXX $CXXFLAGS $INCLUDES -c "$src" -o "obj/i18n/$name.o" 2>&1 || echo "Warning: $src failed"
          done
          
          echo "=== Creating static libraries ==="
          $AR rcs $HOME/output/libi2pd.a obj/libi2pd/*.o 2>/dev/null || true
          $AR rcs $HOME/output/libi2pdclient.a obj/libi2pd_client/*.o 2>/dev/null || true
          $AR rcs $HOME/output/libi2pdlang.a obj/i18n/*.o 2>/dev/null || true
          
          echo "=== Libraries created ==="
          ls -la $HOME/output/*.a 2>/dev/null || echo "No libraries created"

      - name: Collect build artifacts
        if: always()
        run: |
          mkdir -p $HOME/artifacts/{lib,include}
          
          echo "=== Collecting libraries ==="
          cp $HOME/deps/lib/libssl.a $HOME/artifacts/lib/ 2>/dev/null || true
          cp $HOME/deps/lib/libcrypto.a $HOME/artifacts/lib/ 2>/dev/null || true
          cp $HOME/deps/lib/libboost*.a $HOME/artifacts/lib/ 2>/dev/null || true
          cp $HOME/output/*.a $HOME/artifacts/lib/ 2>/dev/null || true
          find ~/i2pd-src -name "*.a" -exec cp {} $HOME/artifacts/lib/ \; 2>/dev/null || true
          
          echo "=== Collecting headers ==="
          cp -r $HOME/deps/include/openssl $HOME/artifacts/include/ 2>/dev/null || true
          cp -r $HOME/deps/include/boost $HOME/artifacts/include/ 2>/dev/null || true
          mkdir -p $HOME/artifacts/include/i2pd
          cp ~/i2pd-src/libi2pd/*.h $HOME/artifacts/include/i2pd/ 2>/dev/null || true
          cp ~/i2pd-src/libi2pd_client/*.h $HOME/artifacts/include/i2pd/ 2>/dev/null || true
          
          echo "=== Artifacts collected ==="
          find $HOME/artifacts -type f | head -50
          
          echo "=== Library details ==="
          for lib in $HOME/artifacts/lib/*.a; do
            if [ -f "$lib" ]; then
              echo "--- $lib ---"
              file "$lib"
              lipo -info "$lib" 2>/dev/null || true
            fi
          done

      - name: Create XCFramework
        if: always()
        run: |
          cd $HOME/artifacts
          
          # Create combined library if we have multiple i2pd libs
          if [ -f lib/libi2pd.a ] && [ -f lib/libi2pdclient.a ]; then
            echo "=== Creating combined libi2pd_combined.a ==="
            libtool -static -o lib/libi2pd_combined.a lib/libi2pd.a lib/libi2pdclient.a lib/libi2pdlang.a 2>/dev/null || true
          fi
          
          # Create XCFramework structure
          mkdir -p i2pd.xcframework/ios-arm64
          cp lib/*.a i2pd.xcframework/ios-arm64/ 2>/dev/null || true
          cp -r include i2pd.xcframework/ios-arm64/ 2>/dev/null || true
          
          # Create Info.plist
          cat > i2pd.xcframework/Info.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>AvailableLibraries</key>
            <array>
              <dict>
                <key>LibraryIdentifier</key>
                <string>ios-arm64</string>
                <key>LibraryPath</key>
                <string>libi2pd.a</string>
                <key>SupportedArchitectures</key>
                <array>
                  <string>arm64</string>
                </array>
                <key>SupportedPlatform</key>
                <string>ios</string>
              </dict>
            </array>
            <key>CFBundlePackageType</key>
            <string>XFWK</string>
            <key>XCFrameworkFormatVersion</key>
            <string>1.0</string>
          </dict>
          </plist>
          PLIST
          
          echo "=== XCFramework structure ==="
          find i2pd.xcframework -type f

      - name: Upload i2pd library artifacts
        uses: actions/upload-artifact@v4
        with:
          name: i2pd-ios-arm64-libs
          path: |
            ~/artifacts/lib/*.a
            ~/artifacts/include/
            ~/artifacts/i2pd.xcframework/
          retention-days: 30
          if-no-files-found: warn

      - name: Build summary
        if: always()
        run: |
          echo "## i2pd iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Libraries Built:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la $HOME/artifacts/lib/*.a 2>/dev/null || echo "No libraries found"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Architecture Verification:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          for lib in $HOME/artifacts/lib/*.a; do
            if [ -f "$lib" ]; then
              echo "$(basename $lib): $(lipo -info $lib 2>/dev/null || echo 'unknown')"
            fi
          done
          echo '```' >> $GITHUB_STEP_SUMMARY
